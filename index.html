<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Library Catalog</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUGVyc29uYWwgTGlicmFyeSBDYXRhbG9nIiwic2hvcnRfbmFtZSI6IkxpYnJhcnkiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCJ9">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --nypl-black: #000000;
            --nypl-white: #ffffff;
            --nypl-red: #d32f2f;
            --nypl-gray-50: #f7f7f7;
            --nypl-gray-100: #eeeeee;
            --nypl-gray-200: #e0e0e0;
            --nypl-gray-300: #bdbdbd;
            --nypl-gray-700: #424242;
            --nypl-gray-800: #2c2c2c;
            --accent-blue: #0576b9;
            --accent-gold: #c49a3a;
            --success-green: #4caf50;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--nypl-white);
            color: var(--nypl-black);
            line-height: 1.6;
        }
        
        /* Header */
        header {
            background: var(--nypl-black);
            color: var(--nypl-white);
            padding: 0;
            border-bottom: 4px solid var(--nypl-red);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 20px 30px;
            gap: 24px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .platypus-logo {
            width: 60px;
            height: 60px;
        }
        
        .site-title {
            display: flex;
            flex-direction: column;
        }
        
        .site-title h1 {
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin: 0;
            line-height: 1.2;
        }
        
        .site-title .subtitle {
            font-size: 0.8em;
            font-weight: 400;
            color: var(--nypl-gray-300);
            margin-top: 2px;
            letter-spacing: 0.5px;
        }
        
        .sync-status {
            margin-left: auto;
            font-size: 0.85em;
            padding: 6px 14px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            display: inline-block;
        }
        
        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }
        
        /* Setup Banner */
        .setup-banner {
            background: #fff3cd;
            border-left: 4px solid var(--accent-gold);
            padding: 20px 24px;
            margin-bottom: 30px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .setup-banner h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: var(--nypl-gray-800);
        }
        
        .setup-banner a {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
        }
        
        .setup-banner a:hover {
            text-decoration: underline;
        }
        
        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--nypl-gray-200);
        }
        
        .section-header h2 {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--nypl-black);
            letter-spacing: -0.5px;
        }
        
        .section-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Form Section */
        .form-section {
            background: var(--nypl-gray-50);
            padding: 32px;
            border-radius: 8px;
            margin-bottom: 48px;
            border: 1px solid var(--nypl-gray-200);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--nypl-gray-800);
            margin-bottom: 8px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        input, textarea, select {
            padding: 12px 14px;
            border: 2px solid var(--nypl-gray-300);
            background: white;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            color: var(--nypl-black);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(5, 118, 185, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }
        
        .rating-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .rating-input input {
            flex: 0 0 100px;
        }
        
        .star-display {
            font-size: 1.4em;
            color: var(--accent-gold);
            letter-spacing: 2px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 4px;
            border: 2px solid var(--nypl-gray-200);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin: 0;
            text-transform: none;
            font-weight: 400;
            cursor: pointer;
        }
        
        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--nypl-gray-300);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        
        .search-results.show {
            display: block;
        }
        
        .search-result-item {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--nypl-gray-100);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: var(--nypl-gray-50);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .result-cover {
            width: 50px;
            height: 75px;
            object-fit: cover;
            border-radius: 2px;
            background: var(--nypl-gray-200);
            flex-shrink: 0;
        }
        
        .result-info {
            flex: 1;
            min-width: 0;
        }
        
        .result-title {
            font-weight: 600;
            color: var(--nypl-black);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .result-author {
            font-size: 0.9em;
            color: var(--nypl-gray-700);
            margin-bottom: 4px;
        }
        
        .result-published {
            font-size: 0.8em;
            color: var(--nypl-gray-700);
        }
        
        .search-loading {
            padding: 16px;
            text-align: center;
            color: var(--nypl-gray-700);
        }
        
        .search-no-results {
            padding: 16px;
            text-align: center;
            color: var(--nypl-gray-700);
        }
        
        /* Selected Book Display */
        .selected-book-card {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: white;
            border: 2px solid var(--success-green);
            border-radius: 4px;
            align-items: center;
            position: relative;
        }
        
        .selected-cover {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 2px;
            background: var(--nypl-gray-200);
        }
        
        .selected-info {
            flex: 1;
        }
        
        .selected-title {
            font-weight: 600;
            color: var(--nypl-black);
            margin-bottom: 4px;
            font-size: 1em;
        }
        
        .selected-author {
            color: var(--nypl-gray-700);
            font-size: 0.9em;
        }
        
        .clear-selection {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--nypl-red);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .clear-selection:hover {
            background: #b71c1c;
        }
        
        /* Buttons */
        button {
            padding: 14px 28px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button.primary {
            background: var(--nypl-black);
            color: white;
        }
        
        button.primary:hover {
            background: var(--nypl-gray-800);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        button.secondary {
            background: white;
            color: var(--nypl-black);
            border: 2px solid var(--nypl-black);
        }
        
        button.secondary:hover {
            background: var(--nypl-gray-50);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* Book Grid */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }
        
        .book-card {
            background: white;
            border: 1px solid var(--nypl-gray-200);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .book-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-4px);
            border-color: var(--nypl-gray-300);
        }
        
        .book-status-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .book-status-badge.finished {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .book-status-badge.in-progress {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .book-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--nypl-black);
            margin-bottom: 8px;
            line-height: 1.3;
            padding-right: 100px;
        }
        
        .book-author {
            font-size: 1em;
            color: var(--nypl-gray-700);
            margin-bottom: 16px;
            font-style: italic;
        }
        
        .book-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
            color: var(--nypl-gray-700);
        }
        
        .meta-label {
            font-weight: 600;
            color: var(--nypl-gray-800);
        }
        
        .version-badge {
            padding: 3px 10px;
            background: var(--nypl-gray-800);
            color: white;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .book-rating {
            font-size: 1.3em;
            color: var(--accent-gold);
            margin: 12px 0;
            letter-spacing: 2px;
        }
        
        .book-review {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--nypl-gray-200);
            font-size: 0.95em;
            line-height: 1.7;
            color: var(--nypl-gray-800);
        }
        
        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .book-actions button {
            flex: 1;
            padding: 10px 16px;
            font-size: 0.85em;
        }
        
        button.toggle-status {
            background: var(--success-green);
            color: white;
        }
        
        button.toggle-status:hover {
            background: #45a049;
        }
        
        button.toggle-status.mark-progress {
            background: #ff9800;
        }
        
        button.toggle-status.mark-progress:hover {
            background: #f57c00;
        }
        
        button.delete {
            background: transparent;
            color: var(--nypl-red);
            border: 2px solid var(--nypl-red);
        }
        
        button.delete:hover {
            background: var(--nypl-red);
            color: white;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--nypl-gray-700);
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-size: 1.4em;
            margin-bottom: 8px;
            color: var(--nypl-gray-800);
        }
        
        .empty-state p {
            font-size: 1em;
            color: var(--nypl-gray-700);
        }
        
        /* Status Indicator */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--nypl-black);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            font-size: 0.95em;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                padding: 16px 20px;
            }
            
            .sync-status {
                margin-left: 0;
                margin-top: 8px;
            }
            
            .container {
                padding: 24px 20px;
            }
            
            .books-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    
    <header>
        <div class="header-content">
            <div class="logo-container">
                <svg class="platypus-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Platypus in NYPL Lion style - iconic, dignified, simplified -->
                    <defs>
                        <style>
                            .platypus-body { fill: #ffffff; }
                            .platypus-detail { fill: #d32f2f; }
                        </style>
                    </defs>
                    
                    <!-- Body -->
                    <ellipse class="platypus-body" cx="50" cy="55" rx="28" ry="20"/>
                    
                    <!-- Head -->
                    <ellipse class="platypus-body" cx="50" cy="35" rx="20" ry="18"/>
                    
                    <!-- Bill -->
                    <path class="platypus-detail" d="M 35 30 Q 20 28, 15 30 Q 20 32, 35 32 Z"/>
                    <path class="platypus-detail" d="M 35 28 L 15 28 L 15 32 L 35 32 Z" opacity="0.3"/>
                    
                    <!-- Eye -->
                    <circle class="platypus-body" cx="48" cy="32" r="3" fill="#000000"/>
                    
                    <!-- Tail -->
                    <path class="platypus-body" d="M 75 58 Q 88 55, 90 52 Q 88 48, 75 50 Z"/>
                    
                    <!-- Front legs/flippers -->
                    <ellipse class="platypus-body" cx="40" cy="68" rx="8" ry="12" transform="rotate(-20 40 68)"/>
                    <ellipse class="platypus-body" cx="60" cy="68" rx="8" ry="12" transform="rotate(20 60 68)"/>
                    
                    <!-- Back legs -->
                    <ellipse class="platypus-body" cx="38" cy="72" rx="6" ry="10" transform="rotate(-30 38 72)"/>
                    <ellipse class="platypus-body" cx="62" cy="72" rx="6" ry="10" transform="rotate(30 62 72)"/>
                    
                    <!-- Body detail lines -->
                    <path class="platypus-detail" d="M 50 42 Q 52 50, 50 60" stroke="#d32f2f" stroke-width="1" fill="none" opacity="0.3"/>
                </svg>
                <div class="site-title">
                    <h1>Personal Library</h1>
                    <span class="subtitle">Digital Catalog</span>
                </div>
            </div>
            <div class="sync-status" id="syncStatus">
                <span class="sync-indicator"></span>
                <span>Connecting...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Setup Banner -->
        <div class="setup-banner" id="setupBanner" style="display: none;">
            <h3>ðŸ“± Enable Cross-Device Syncing</h3>
            <p>Currently using local storage. To sync across all your devices, set up Firebase by following the instructions in the README. Takes about 5 minutes and is completely free!</p>
        </div>

        <!-- Add Book Section -->
        <section>
            <div class="section-header">
                <h2>Add to Collection</h2>
            </div>
            
            <div class="form-section">
                <form id="addBookForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="bookSearch">Search Book</label>
                            <div style="position: relative;">
                                <input 
                                    type="text" 
                                    id="bookSearch" 
                                    required 
                                    placeholder="Search by title or author..."
                                    autocomplete="off"
                                >
                                <div id="searchResults" class="search-results"></div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: none;" id="selectedBookDisplay">
                            <label>Selected Book</label>
                            <div class="selected-book-card">
                                <img id="selectedCover" src="" alt="Book cover" class="selected-cover">
                                <div class="selected-info">
                                    <div id="selectedTitle" class="selected-title"></div>
                                    <div id="selectedAuthor" class="selected-author"></div>
                                </div>
                                <button type="button" onclick="clearSelectedBook()" class="clear-selection">âœ•</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="rating">Rating</label>
                            <div class="rating-input">
                                <input type="text" id="rating" placeholder="0-5" value="0" inputmode="decimal">
                                <span class="star-display" id="starDisplay">â˜†â˜†â˜†â˜†â˜†</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="version">Format</label>
                            <select id="version">
                                <option value="audiobook">Audiobook</option>
                                <option value="text">Text</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="review">Review</label>
                            <textarea id="review" placeholder="Share your thoughts about this book..."></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <div class="checkbox-group">
                                <input type="checkbox" id="finished">
                                <label for="finished">Mark as finished (will be included in next export)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="primary">Add to Library</button>
                        <button type="button" onclick="manualSync()" class="secondary">Export to CSV</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Books Collection -->
        <section>
            <div class="section-header">
                <h2>My Collection</h2>
                <div class="section-actions">
                    <span id="bookCount" style="color: var(--nypl-gray-700); font-size: 0.9em;"></span>
                </div>
            </div>
            
            <div id="booksGrid" class="books-grid"></div>
        </section>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";
        
        let db = null;
        let booksCollection = null;
        let unsubscribe = null;
        
        if (isFirebaseConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                booksCollection = collection(db, 'books');
                updateSyncStatus('Synced', true);
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateSyncStatus('Local only', false);
                document.getElementById('setupBanner').style.display = 'block';
            }
        } else {
            updateSyncStatus('Local only', false);
            document.getElementById('setupBanner').style.display = 'block';
        }
        
        function updateSyncStatus(message, synced) {
            const statusEl = document.getElementById('syncStatus');
            const indicator = statusEl.querySelector('.sync-indicator');
            const text = statusEl.querySelector('span:last-child');
            
            text.textContent = message;
            indicator.style.background = synced ? '#4caf50' : '#ff9800';
        }
        
        // LocalStorage fallback
        class LocalStorage {
            async getBooks() {
                try {
                    const data = localStorage.getItem('library-books');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    return [];
                }
            }
            
            async saveBooks(books) {
                localStorage.setItem('library-books', JSON.stringify(books));
            }
            
            async addBook(book) {
                const books = await this.getBooks();
                book.id = Date.now().toString();
                books.push(book);
                await this.saveBooks(books);
                return book;
            }
            
            async deleteBook(id) {
                const books = await this.getBooks();
                const filtered = books.filter(b => b.id !== id);
                await this.saveBooks(filtered);
            }
            
            async updateBook(id, updates) {
                const books = await this.getBooks();
                const index = books.findIndex(b => b.id === id);
                if (index !== -1) {
                    books[index] = { ...books[index], ...updates };
                    await this.saveBooks(books);
                }
            }
        }
        
        const localStorage_storage = new LocalStorage();
        let books = [];
        let selectedBook = null;
        let searchTimeout = null;
        
        // Google Books API
        const GOOGLE_BOOKS_API = 'https://www.googleapis.com/books/v1/volumes';
        
        async function searchGoogleBooks(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const response = await fetch(`${GOOGLE_BOOKS_API}?q=${encodeURIComponent(query)}&maxResults=10&printType=books`);
                const data = await response.json();
                
                if (!data.items) return [];
                
                return data.items.map(item => ({
                    id: item.id,
                    title: item.volumeInfo.title || 'Unknown Title',
                    authors: item.volumeInfo.authors || ['Unknown Author'],
                    publishedDate: item.volumeInfo.publishedDate || '',
                    thumbnail: item.volumeInfo.imageLinks?.thumbnail || item.volumeInfo.imageLinks?.smallThumbnail || '',
                    isbn: item.volumeInfo.industryIdentifiers?.[0]?.identifier || ''
                }));
            } catch (error) {
                console.error('Error searching Google Books:', error);
                return [];
            }
        }
        
        // Setup search input
        const searchInput = document.getElementById('bookSearch');
        const searchResults = document.getElementById('searchResults');
        
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (query.length < 2) {
                searchResults.classList.remove('show');
                return;
            }
            
            // Show loading
            searchResults.innerHTML = '<div class="search-loading">Searching...</div>';
            searchResults.classList.add('show');
            
            // Debounce search
            searchTimeout = setTimeout(async () => {
                const results = await searchGoogleBooks(query);
                displaySearchResults(results);
            }, 300);
        });
        
        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results">No books found. Try a different search.</div>';
                return;
            }
            
            searchResults.innerHTML = results.map(book => `
                <div class="search-result-item" onclick='selectBook(${JSON.stringify(book).replace(/'/g, "&#39;")})'>
                    ${book.thumbnail ? `<img src="${book.thumbnail}" alt="${book.title}" class="result-cover">` : '<div class="result-cover"></div>'}
                    <div class="result-info">
                        <div class="result-title">${book.title}</div>
                        <div class="result-author">${book.authors.join(', ')}</div>
                        ${book.publishedDate ? `<div class="result-published">${book.publishedDate.substring(0, 4)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        window.selectBook = function(book) {
            selectedBook = book;
            
            // Hide search results
            searchResults.classList.remove('show');
            searchInput.value = '';
            
            // Show selected book
            document.getElementById('selectedBookDisplay').style.display = 'block';
            document.getElementById('selectedTitle').textContent = book.title;
            document.getElementById('selectedAuthor').textContent = book.authors.join(', ');
            
            if (book.thumbnail) {
                document.getElementById('selectedCover').src = book.thumbnail;
                document.getElementById('selectedCover').style.display = 'block';
            } else {
                document.getElementById('selectedCover').style.display = 'none';
            }
        };
        
        window.clearSelectedBook = function() {
            selectedBook = null;
            document.getElementById('selectedBookDisplay').style.display = 'none';
            searchInput.value = '';
        };
        
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('show');
            }
        });
        
        // Load books
        async function loadBooks() {
            if (isFirebaseConfigured && db) {
                const q = query(booksCollection, orderBy('dateAdded', 'desc'));
                unsubscribe = onSnapshot(q, (snapshot) => {
                    books = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderBooks();
                });
            } else {
                books = await localStorage_storage.getBooks();
                renderBooks();
            }
        }
        
        // Add book
        async function addBook(bookData) {
            if (isFirebaseConfigured && db) {
                try {
                    await addDoc(booksCollection, bookData);
                    showToast('Book added to collection');
                } catch (error) {
                    console.error('Error adding book:', error);
                    showToast('Error adding book');
                }
            } else {
                await localStorage_storage.addBook(bookData);
                books = await localStorage_storage.getBooks();
                renderBooks();
                showToast('Book added to collection');
            }
        }
        
        // Delete book
        window.deleteBook = async function(id) {
            if (!confirm('Remove this book from your collection?')) return;
            
            if (isFirebaseConfigured && db) {
                try {
                    await deleteDoc(doc(db, 'books', id));
                    showToast('Book removed');
                } catch (error) {
                    showToast('Error removing book');
                }
            } else {
                await localStorage_storage.deleteBook(id);
                books = await localStorage_storage.getBooks();
                renderBooks();
                showToast('Book removed');
            }
        };
        
        // Toggle book status
        window.toggleBookStatus = async function(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;
            
            const newStatus = !book.finished;
            
            if (isFirebaseConfigured && db) {
                try {
                    await updateDoc(doc(db, 'books', id), { finished: newStatus });
                    showToast(newStatus ? 'Marked as finished' : 'Marked as in progress');
                } catch (error) {
                    showToast('Error updating status');
                }
            } else {
                await localStorage_storage.updateBook(id, { finished: newStatus });
                books = await localStorage_storage.getBooks();
                renderBooks();
                showToast(newStatus ? 'Marked as finished' : 'Marked as in progress');
            }
        };
        
        // Rating display and validation
        function updateStarDisplay(rating) {
            const starDisplay = document.getElementById('starDisplay');
            const fullStars = Math.floor(rating);
            const hasQuarter = (rating % 1) === 0.25;
            const hasHalf = (rating % 1) === 0.5;
            const hasThreeQuarter = (rating % 1) === 0.75;
            
            let stars = '';
            for (let i = 0; i < fullStars; i++) stars += 'â˜…';
            if (hasQuarter) stars += 'â—”';
            else if (hasHalf) stars += 'â—';
            else if (hasThreeQuarter) stars += 'â—•';
            
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) stars += 'â˜†';
            
            starDisplay.textContent = stars;
        }
        
        // Round to nearest .25 increment
        function roundToQuarter(num) {
            return Math.round(num * 4) / 4;
        }
        
        // Handle rating input with auto-decimal and validation
        const ratingInput = document.getElementById('rating');
        
        ratingInput.addEventListener('input', (e) => {
            let value = e.target.value;
            
            // Remove any non-numeric characters except decimal point
            value = value.replace(/[^\d.]/g, '');
            
            // If user enters more than one decimal point, keep only the first
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Auto-insert decimal after first digit if user types a second digit
            if (value.length === 2 && !value.includes('.')) {
                value = value[0] + '.' + value[1];
            }
            
            // Limit to 3 characters (e.g., "5.75")
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            // Update the input field
            e.target.value = value;
            
            // Parse and validate the number
            let numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                numValue = 0;
            }
            
            // Clamp between 0 and 5
            numValue = Math.max(0, Math.min(5, numValue));
            
            // Update star display with current value
            updateStarDisplay(numValue);
        });
        
        // On blur, round to nearest .25 and format
        ratingInput.addEventListener('blur', (e) => {
            let value = e.target.value;
            
            if (value === '' || value === '.') {
                e.target.value = '0';
                updateStarDisplay(0);
                return;
            }
            
            let numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                numValue = 0;
            }
            
            // Clamp between 0 and 5
            numValue = Math.max(0, Math.min(5, numValue));
            
            // Round to nearest .25
            numValue = roundToQuarter(numValue);
            
            // Format the value
            e.target.value = numValue.toFixed(2).replace(/\.?0+$/, '');
            
            updateStarDisplay(numValue);
        });
        
        // Toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // CSV Export
        function generateStorygraphCSV(newBooks) {
            const headers = ['Title', 'Authors', 'My Rating', 'Review', 'Read Status'];
            const rows = newBooks.map(book => [
                book.title, book.author, book.rating, book.review || '', 'read'
            ]);
            return [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');
        }
        
        function generateGoodreadsCSV(newBooks) {
            const today = new Date().toISOString().split('T')[0];
            const headers = ['Title', 'Author', 'My Rating', 'Date Read', 'My Review'];
            const rows = newBooks.map(book => [
                book.title, book.author, book.rating, today, book.review || ''
            ]);
            return [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        async function getLastSyncDate() {
            const data = localStorage.getItem('last-sync-date');
            return data ? new Date(data) : new Date(0);
        }
        
        async function setLastSyncDate(date) {
            localStorage.setItem('last-sync-date', date.toISOString());
        }
        
        async function getNewFinishedBooks() {
            const lastSync = await getLastSyncDate();
            return books.filter(book => book.finished && new Date(book.dateAdded) > lastSync);
        }
        
        window.manualSync = async function() {
            const newBooks = await getNewFinishedBooks();
            
            if (newBooks.length === 0) {
                showToast('No new finished books to export');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            downloadCSV(generateStorygraphCSV(newBooks), `storygraph-${timestamp}.csv`);
            await new Promise(resolve => setTimeout(resolve, 500));
            downloadCSV(generateGoodreadsCSV(newBooks), `goodreads-${timestamp}.csv`);
            await setLastSyncDate(new Date());
            showToast(`Exported ${newBooks.length} book(s)`);
        };
        
        // Render books
        function renderBooks() {
            const container = document.getElementById('booksGrid');
            const countEl = document.getElementById('bookCount');
            
            countEl.textContent = `${books.length} book${books.length !== 1 ? 's' : ''}`;
            
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 2H9c-1.1 0-2 .9-2 2v5.5c0 .8.7 1.5 1.5 1.5s1.5-.7 1.5-1.5V4h9v16h-9v-2H9v2c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            <path d="M3 6c-.6 0-1 .4-1 1v10c0 .6.4 1 1 1h9c.6 0 1-.4 1-1V7c0-.6-.4-1-1-1H3zm0 11V7h9v10H3z"/>
                        </svg>
                        <h3>Your library is empty</h3>
                        <p>Add your first book to get started</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = books.map(book => `
                <div class="book-card">
                    <span class="book-status-badge ${book.finished ? 'finished' : 'in-progress'}">
                        ${book.finished ? 'Finished' : 'In Progress'}
                    </span>
                    
                    ${book.thumbnail ? `
                        <div style="text-align: center; margin-bottom: 16px;">
                            <img src="${book.thumbnail}" alt="${book.title}" style="max-width: 100px; height: auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                        </div>
                    ` : ''}
                    
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author}</div>
                    
                    <div class="book-meta">
                        <div class="meta-item">
                            <span class="meta-label">Format:</span>
                            <span class="version-badge">${book.version}</span>
                        </div>
                    </div>
                    
                    <div class="book-rating">${generateStars(book.rating)}</div>
                    
                    ${book.review ? `<div class="book-review">${book.review}</div>` : ''}
                    
                    <div class="book-actions">
                        <button onclick="toggleBookStatus('${book.id}')" class="toggle-status ${book.finished ? 'mark-progress' : ''}">
                            ${book.finished ? 'Mark In Progress' : 'Mark Finished'}
                        </button>
                        <button onclick="deleteBook('${book.id}')" class="delete">Remove</button>
                    </div>
                </div>
            `).join('');
        }
        
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasQuarter = (rating % 1) === 0.25;
            const hasHalf = (rating % 1) === 0.5;
            const hasThreeQuarter = (rating % 1) === 0.75;
            
            let stars = '';
            for (let i = 0; i < fullStars; i++) stars += 'â˜…';
            if (hasQuarter) stars += 'â—”';
            else if (hasHalf) stars += 'â—';
            else if (hasThreeQuarter) stars += 'â—•';
            
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) stars += 'â˜†';
            
            return stars;
        }
        
        // Form submission
        document.getElementById('addBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate that a book has been selected
            if (!selectedBook) {
                showToast('Please select a book from the search results');
                return;
            }
            
            const book = {
                title: selectedBook.title,
                author: selectedBook.authors.join(', '),
                googleBooksId: selectedBook.id,
                isbn: selectedBook.isbn,
                thumbnail: selectedBook.thumbnail,
                rating: parseFloat(document.getElementById('rating').value) || 0,
                version: document.getElementById('version').value,
                review: document.getElementById('review').value,
                finished: document.getElementById('finished').checked,
                dateAdded: new Date().toISOString()
            };
            
            await addBook(book);
            
            // Reset form and selected book
            e.target.reset();
            clearSelectedBook();
            updateStarDisplay(0);
            document.getElementById('rating').value = '0';
        });
        
        // Initialize
        updateStarDisplay(0);
        loadBooks();
    </script>
</body>
</html>
